# TO BUILD: sudo singularity build egep.sif egep.sif.def

Bootstrap: docker
From: ubuntu:20.04

%post
    # Set timezone to avoid interactive prompts
    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/UTC /etc/localtime

    # Update and install basic dependencies
    apt-get update && apt-get install -y \
        wget \
        curl \
        bzip2 \
        && apt-get clean

    # Install Miniconda
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    bash miniconda.sh -b -p /opt/conda
    rm miniconda.sh
    /opt/conda/bin/conda init bash

    # Update PATH for Conda
    export PATH="/opt/conda/bin:$PATH"

    # Create a Conda environment for EGEP
    conda create -n EGEP_env python=3.12 -y

    # Activate the environment and install dependencies
    /bin/bash -c "source /opt/conda/etc/profile.d/conda.sh && \
                  conda activate EGEP_env && \
                  conda install -c bioconda -c conda-forge mafft iqtree pandas biopython seaborn matplotlib -y && \
                  python -c 'from Bio import SeqIO; import pandas, seaborn, matplotlib; print(\"All Python packages installed successfully\")'"

%environment
    # Set PATH to include Conda environment
    export PATH="/opt/conda/envs/EGEP_env/bin:/opt/conda/bin:$PATH"

%runscript
    # Ensure the Conda environment is activated when running the container
    exec /bin/bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate EGEP_env && exec \"\$@\""
    
# TO CONFIRM: python 